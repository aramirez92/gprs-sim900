<<<<<<< HEAD
gprs.sendSMS(number, message, callback)
=======
var tessel = require('tessel');
var hardware = tessel.port('d');

var uart = hardware.UART({baudrate: 19200});
var g3 = hardware.gpio(3)
          .output()
          .high();
var txCount = 0;
var rxCount = 0;

//////////////////////////////////////////////////////////////////////////////

function decode(array)
{
  var decoded = '';
  for (var i = 0; i < array.length; i++)
  {
    if (array[i] < 14) 
      decoded += '\n'
    else
      decoded += String.fromCharCode(array[i]);
  }
  return decoded; 
}

function printRecieved(r)
{
  message = decode(r)
  // if (message == '\n\nUNDER-VOLTAGE WARNNING\n\n')
  //   return
  console.log(rxCount, '\tRecieved:\n\t', message, '\n');
  rxCount++;
}

function send(cmd, verbose)
{
  verbose = verbose || 0;
  uart.write(cmd);
  if (verbose)
  {  
    console.log(txCount, '\tSent:\n\t', cmd);
    txCount++;
  }
}

function SMS(number, message)
{
  number = String(number) || '15555555555';   //  sorry, not sorry, Jia
  message = message || 'text from a Tessel';

  setTimeout(function(){
    send('AT\r\n');
    setTimeout(function(){
      send('AT+CMGF=1\r\n');
      setTimeout(function(){
        send('AT+CMGS="' + number + '"\r\n');
        setTimeout(function(){
          send(message + '\r\n');
          setTimeout(function(){
            send([0x1A]);
            }, 3000);//2000);
          }, 2000);//750);
        }, 2000);//500);
      }, 2000);//500);
    }, 2000);//500);
}

function heyListen(reps)
{
  //  make sure the module is awake
  reps = reps || 3;
  for (var i = 0; i < reps; i++)
  {
    setTimeout(function(){
      send('AT', 1);
    }, 500 * (i + 1));
  }
}

function getNotificationSetting()
{
  send('AT+CGEREP?\r\n');
}

function setNotifications(mode, clearBuffer)
>>>>>>> 4bff1e1e4fa826095d34afbf62e151e60948a279
{
  /*
  send an SMS to the specified number

  args
    number
      a string representation of the number. must be at least 10 digits
    message
      a string to send
    callback
      callback function

  callback parameters
    none
  */
}

gprs.dial(number, callback)
{
  /*
  call the specified number

  args
    number
      a string representation of the number. must be at least 10 digits
    callback
      callback function

  callback parameters
    call
      a call object
  */
}

gprs.answerCall(callback)
{
  /*
  answer an incoming voice call

  args
    callback
      callback function

  callback parameters
    call
      a call object
  */
}

gprs.ignoreCall(callback)
{
  /*
  ignore an incoming voice call

  args
    callback
      callback function

  callback parameters
    none
  */
}

gprs.readSMS(messageNumber, callback)
{
  /*
  answer an incoming voice call

  args - two possibilities
    messageNumber
      the index of the message to read. if not specified, the newest message is read
    callback
      callback function

  callback parameters
    err
      error
    message
      the SMS string
  */
<<<<<<< HEAD
}
=======

  mode = mode || '?';

  if (mode == '?')      //  read
    send('AT+CAAS?\r\n');
  else                  //  write
    send('AT+CAAS=' + mode + '\r\n');
}


////////////////////////////////////////////////////////////////////////////////

var led1 = tessel.led(1).output().high();
var led2 = tessel.led(2).output().low();

setInterval(function () {
  led1.toggle();
  led2.toggle();
}, 250);


process.on('message', function (data) {
  // console.log(data.substring(1, data.length-1));
  send(data.substring(1, data.length - 1) + "\r\n");
});

console.log('waiting for messages...');

uart.on('data', function(bytes) {
  printRecieved(bytes);
});

console.log('gogogo!');
tessel.sleep(50);
// g3.low();
// tessel.sleep(1200);
// g3.high();
// tessel.sleep(3000);

heyListen();

tessel.sleep(100);

// setTimeout(function () {
//   SMS(15555555555, "test") 
//   }, 25000);

// setInterval(function(){
//   send('AT+CMGR=1,1\r\n');
// }, 4000);

// setInterval(function(){
//   send('AT+CMGR=2,1\r\n');
// }, 5000);


// setInterval(function(){
//   send('AT+CMGR=3,1\r\n');
// }, 6000);

// setInterval(function(){
//   send('AT+CMGR=4,1\r\n');
// }, 7000);

// SMS(phone#,'messagetext');







//    for history's sake

// THIS BLOCK WORKED
// var characters = 'AT\r\n'
// send(characters);
// tessel.sleep(2000);

// characters = 'AT+CMGF=1\r\n'
// send(characters);x
// tessel.sleep(2000);

// characters = 'AT+CMGS="15555555555"\r\n'
// send(characters);
// tessel.sleep(2000);

// characters = 'text from a Tessel\r\n'
// send(characters);
// tessel.sleep(2000);

// characters = [0x1A]
// send(characters);




>>>>>>> 4bff1e1e4fa826095d34afbf62e151e60948a279
